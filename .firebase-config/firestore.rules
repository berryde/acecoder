rules_version = '2';
service cloud.firestore {

  match /databases/{database}/documents {
    match /certificates/{certificateID} {
      allow read
      allow write: if
        request.auth != null && request.auth.token.admin == true;
    }
    match /projects {
      // Allow all nested documents to be read by authenticated users and written by admins.
      match /{document=**} {
        allow read: if
          request.auth != null
        allow write: if
          request.auth != null && request.auth.token.admin == true;
      }
      match /{pid} {
        match /exercises/{eid}/results/{uid} {
          allow read: if
            request.auth != null && request.auth.uid == uid
        }
        // Users should only be able to load and change their own submissions.
        match /submissions/{uid} {
          allow read, write: if
            request.auth != null && request.auth.uid == uid
        }
      }
      // Allow user settings to be read and updated by that user.
      match /{pid}/settings/{uid} {
        allow read, delete: if
          request.auth != null && request.auth.uid == uid
      }
    }
    // Certificates are public and read only
    match /stats/{uid}/{document=**} {
      allow read;
    }
    // Certificates are public and read only
    match /certificates/{certificateID} {
      allow read;
    }
    match /badges/{id} {
      allow read;
      allow write: if
        request.auth != null && request.auth.token.admin == true;
    }
    match /names/{uid} {
      allow read;
      allow write: if
        request.auth != null && request.auth.uid == uid
    }
  }
}