rules_version = '2';
service cloud.firestore {

  match /databases/{database}/documents {
    // Users should only be able to view and change their own settings
    match /settings/{uid} {
      allow write: if
        request.auth != null && uid == request.auth.uid
      allow read: if
        request.auth != null && uid == request.auth.uid
    }
    match /projects {
      // Allow all nested documents to be read by authenticated users and written by admins.
      match /{document=**} {
        allow read: if
          request.auth != null
        allow write: if
          request.auth != null && request.auth.token.admin == true;
      }
      match /{pid}/exercises/{eid} {
        // Users should only be able to read their own results.
        match /results/{uid} {
          allow read: if
            request.auth != null && request.auth.uid == uid
        }
        // Users should only be able to load and change their own submissions.
        match /submissions/{uid} {
          allow read, write: if
            request.auth != null && request.auth.uid == uid
        }
      }
      // Allow user settings to be read and updated by that user.
      match /{pid}/settings/{uid} {
        allow read, write: if
          request.auth != null && request.auth.uid == uid
      }
    }
  }
}